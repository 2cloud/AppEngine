<html>
    <head>
        <title>Stats Dashboard</title>
        <script src="/_ah/channel/jsapi"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js" type="text/javascript"></script>
        <script src="/js/highcharts.js" type="text/javascript"></script>
        <script src="/js/jquery.color.js" type="text/javascript"></script>
        <script type="text/javascript">
            var chart1;
            var chart2;
            $(document).ready(function() {
                chart1 = new Highcharts.Chart({
                    chart: {
                        renderTo: 'hourly_chart',
                        type: 'area'
                    },
                    title: {
                        text: 'Hourly Stats'
                    },
                    xAxis: {
                        title: {
                            text: 'Date'
                        },
                        type: 'datetime',
                        maxZoom: 86400000
                    },
                    yAxis: {
                        title: {
                            text: 'Number'
                        }
                    },
                    series: [{% for datapoint in stats.hour %}{
                        id: '{{ datapoint.0.name }}-hour',
                        name: '{{ datapoint.0.name }}',
                        data: [{% for value in datapoint %}
                              [{{value.timestamp}}, {{value.count}}],
                              {% endfor %}]
                            },{% endfor %}
                    ],
                    credits: {
                        enabled: false
                    },
                });

                chart2 = new Highcharts.Chart({
                    chart: {
                        renderTo: 'daily_chart',
                        type: 'area'
                    },
                    title: {
                        text: 'Daily Stats'
                    },
                    xAxis: {
                        title: {
                            text: 'Date'
                        },
                        type: 'datetime',
                   },
                    series: [{% for datapoint in stats.day %}{
                        id: '{{ datapoint.0.name }}-day',
                        name: '{{ datapoint.0.name }}',
                        data: [{% for value in datapoint %}
                              [{{ value.timestamp }}, {{ value.count }}],
                              {% endfor %}]
                            },{% endfor %}
                    ],
                    credits: {
                        enabled: false
                    }
                });
            });
            
            function addOrUpdate(timestamp, value, datapoint, duration) {
                console.log(timestamp +", "+ value +", "+datapoint+", "+duration);
                var updated = false;
                chart = null;
                if(duration == 'hour')
                    chart = chart1;
                else
                    chart = chart2;
                console.log(chart);
                var series = chart.get(datapoint+'-'+duration);
                if(series == null) {
                    chart.addSeries({
                        id: datapoint+'-'+duration,
                        name: datapoint,
                        data: [[timestamp, value]]
                        });
                    series = chart.get(datapoint);
                }
                for(d=0; d < series.data.length; d++) {
                    if(series.data[d].x == timestamp) {
                        series.data[d].update(value);
                        updated = true;
                        d = series.data.length;
                        continue;
                    }
                }
                if(!updated) {
                    series.addPoint([timestamp, value]);
                }
                var table = $('#'+datapoint+'-table');
                var tr = $('#'+datapoint+'_'+timestamp+'-tr');
                var date_td = $('#'+datapoint+'_'+timestamp+'_date-td');
                var count_td = $('#'+datapoint+'_'+timestamp+'_count-td');
                count_td.text(value);
                if(tr.attr('class') == 'odd')
                    tr.animate({backgroundColor: '#cceeff'}).animate({backgroundColor: '#eeffff'});
                else
                    tr.animate({backgroundColor: '#eeffff'}).animate({backgroundColor: '#cceeff'});
            }
        </script>
        <style>
            h2 {
                text-align: center;
            }

            table {
                margin: 0 auto;
            }

            tr.odd {
                background-color: #eeffff;
            }

            tr.even {
                background-color: #cceeff;
            }

            td {
                padding: 10px;
                font-size: 0.9em;
            }

            th {
                border-bottom: 3px #000 solid;
            }
        </style>
    </head>
    <body>
        <script type="text/javascript">
            var token = "{{ channel_id }}";
            var channel = new goog.appengine.Channel(token);
            var socket = channel.open();
            socket.onmessage = function(evt) {
                console.log(evt.data);
                message = JSON.parse(evt.data);
                for(x = 0; x < message.stats.length; x++)
                    addOrUpdate(message.stats[x].timestamp, message.stats[x].count, message.stats[x].datapoint, message.stats[x].duration);
            }
        </script>
        <div id="daily_chart" style="width: 49%; height: 400px; float: left;"></div>
        <div id="hourly_chart" style="width: 49%; height: 400px; float: left;"></div>
        <br style="clear: both;" />
        <div style="float: left; width: 49%;">
        {% for datapoint in stats.day %}
        <div style="float: left; padding: 20px;">
        <h2 style="text-align: center;">Daily {{ datapoint.0.name }}</h2>
        <table style="margin: 0 auto;" id="{{ datapoint.0.name }}-table">
            <tr>
                <th>Date</th>
                <th>Count</th>
            </tr>
            {% for value in datapoint %}
            <tr class="{% cycle odd,even %}" id="{{ value.name }}_{{ value.timestamp }}-tr">
                <td id="{{ value.name }}_{{ value.timestamp }}_name-td">{{ value.date }}</td>
                <td style="text-align: right;" id="{{ value.name }}_{{ value.timestamp }}_count-td">{{ value.count }}</td>

            </tr>{% endfor %}
        </table>
    </div>{% endfor %}
    </div>
    <div style="float: left; width: 49%;">
        {% for datapoint in stats.hour %}
        <div style="float: left; padding: 20px;">
        <h2 style="text-align: center;">Hourly {{ datapoint.0.name }}</h2>
        <table style="margin: 0 auto;" id="{{ datapoint.0.name }}-table">
            <tr>
                <th>Date</th>
                <th>Count</th>
            </tr>
            {% for value in datapoint %}
            <tr class="{% cycle odd,even %}" id="{{ value.name }}_{{ value.timestamp }}-tr">
                <td id="{{ value.name }}_{{ value.timestamp }}_name-td">{{ value.date }}</td>
                <td style="text-align: right;" id="{{ value.name }}_{{ value.timestamp }}_count-td">{{ value.count }}</td>

            </tr>{% endfor %}
        </table>
    </div>{% endfor %}
    </div>
    <br style="clear: both;" />
    </body>
</html>
