<html>
    <head>
        <title>Stats Dashboard</title>
        <script src="/_ah/channel/jsapi"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js" type="text/javascript"></script>
        <script src="/js/jquery.color.js" type="text/javascript"></script>
        <script type="text/javascript">
            function addOrUpdate(timestamp, date, value, datapoint, duration) {
                var table = $('#'+datapoint+'-table');
                var firstRow = $('#'+datapoint+'-table tr:first');
                var tr = $('#'+datapoint+'_'+timestamp+'-tr');
                var date_td = $('#'+datapoint+'_'+timestamp+'_date-td');
                var count_td = $('#'+datapoint+'_'+timestamp+'_count-td');
                if(tr.length == 0) {
                    if(firstRow.attr('class') == 'odd') {
                        newClass = 'even';
                    } else {
                        newClass = 'odd';
                    }
                    newRow = "<tr class='"+newClass+"' id='"+datapoint+"_"+timestamp+"-tr'>";
                    newRow += "<td id='"+datapoint+"_"+timestamp+"_date-td'>"+date+"</td>";
                    newRow += "<td id='"+datapoint+"_"+timestamp+"_count-td'>"+value+"</td>";
                    newRow += "</tr>"
                    $('#'+datapoint+'-table tr:first').before(newRow);
                } else {
                    count_td.text(value);
                }
                if(tr.attr('class') == 'odd')
                    tr.animate({backgroundColor: '#cceeff'}).animate({backgroundColor: '#eeffff'});
                else
                    tr.animate({backgroundColor: '#eeffff'}).animate({backgroundColor: '#cceeff'});
            }
        </script>
        <style>
            h2 {
                text-align: center;
            }

            table {
                margin: 0 auto;
            }

            tr.odd {
                background-color: #eeffff;
            }

            tr.even {
                background-color: #cceeff;
            }

            td {
                padding: 10px;
                font-size: 0.9em;
            }

            th {
                border-bottom: 3px #000 solid;
            }
            .hidden {
                display: none;
            }
            br.clear {
                clear: both;
            }
            img.clear {
                display: none;
            }
        </style>
    </head>
    <body>
        <script type="text/javascript">
            var token = "{{ channel_id }}";
            var channel = new goog.appengine.Channel(token);
            var socket = channel.open();
            socket.onmessage = function(evt) {
                console.log(evt.data);
                message = JSON.parse(evt.data);
                for(x = 0; x < message.stats.length; x++)
                    addOrUpdate(message.stats[x].timestamp, message.stats[x].date, message.stats[x].count, message.stats[x].datapoint, message.stats[x].duration);
            }
        </script>
        <div style="float: left; width: 49%;">
        {% for datapoint in stats.day %}
        <div style="float: left; padding: 20px; width: 42%">
        <h2 style="text-align: center;">Daily {{ datapoint.0.name }}</h2>
        <table style="margin: 0 auto;" id="{{ datapoint.0.name }}-table">
            <tr>
                <th>Date</th>
                <th>Count</th>
            </tr>
            {% for value in datapoint %}
            <tr class="{% cycle odd,even %}" id="{{ value.name }}_{{ value.timestamp }}-tr">
                <td id="{{ value.name }}_{{ value.timestamp }}_name-td">{{ value.date }}</td>
                <td style="text-align: right;" id="{{ value.name }}_{{ value.timestamp }}_count-td">{{ value.count }}</td>

            </tr>{% endfor %}
        </table>
    </div><{% cycle img,br,img,br %} class="clear" />{% endfor %}
    </div>
    <div style="float: left; width: 49%;">
        {% for datapoint in stats.hour %}
        <div style="float: left; padding: 20px; width: 42%;">
        <h2 style="text-align: center;">Hourly {{ datapoint.0.name }}</h2>
        <table style="margin: 0 auto;" id="{{ datapoint.0.name }}-table">
            <tr>
                <th>Date</th>
                <th>Count</th>
            </tr>
            {% for value in datapoint %}
            <tr class="{% cycle odd,even %}" id="{{ value.name }}_{{ value.timestamp }}-tr">
                <td id="{{ value.name }}_{{ value.timestamp }}_name-td">{{ value.date }}</td>
                <td style="text-align: right;" id="{{ value.name }}_{{ value.timestamp }}_count-td">{{ value.count }}</td>

            </tr>{% endfor %}
        </table>
    </div><{% cycle img,br %} class="clear" />{% endfor %}
    </div>
    <br style="clear: both;" />
    </body>
</html>
